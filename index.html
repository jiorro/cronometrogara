<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>connessione box</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 40px; }
    #time { font-size: 2em; margin: 20px; }
    #log { text-align: left; margin: 20px auto; width: 60%; }
  </style>
</head>
<body>
  <h1>ingeniere live</h1>
  <div id="time">00:00.000</div>
  <button id="startMic">Attiva radio</button>
  <p>comandi utilizzabili per far cominciare il cronometro: tempo start via parti</p>
  <p>comandi utilizzabili per far terminare il cronometro: fine stop ferma chiudi</p>
  <p>comandi utilizzabili per segnare un momento sul cronometro: tieni ricorda segna mark</p>
  <p>comandi utilizzabili per gestire i checkmark: spegni checkmark, annulla checkmark, no checkmark, non tieni, annulla tieni, riprendi checkmark</p>
  <div id="log"></div>

<script>
let startTime = null;
let timerInterval = null;
let laps = [];
let checkmarks = [];
let checkmarkActive = true;
let muteMode = false;
let currentLap = 0;
let audioPlaying = false;   // ðŸ”¥ evita loop microfono/audio

// ðŸ”¥ funzione universale per riprodurre audio senza bloccare il mic
function playSound(file) {
  const s = new Audio(file);
  audioPlaying = true;
  s.onended = () => audioPlaying = false;
  s.play();
}

function updateTimer() {
  const elapsed = Date.now() - startTime;
  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);
  document.getElementById("time").textContent =
    String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
}

function startTimer() {
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 200);
  playSound("starttime (1).mp3");
  log("Cronometro avviato");
}

function stopTimer() {
  clearInterval(timerInterval);
  const elapsed = Date.now() - startTime;
  laps.push(elapsed);

  const minutes = Math.floor(elapsed / 60000);
  const seconds = ((elapsed % 60000) / 1000).toFixed(2);

  const best = Math.min(...laps);
  const worst = Math.max(...laps);

if (muteMode) {
    setTimeout(() => playSound("talkno.mp3"), 200);
    log("Tempo: " + minutes + "m " + seconds + "s â†’ silenzioso");
} else {
   if (elapsed <= best) {
        setTimeout(() => playSound("Record (online-voice-recorder (1)).mp3"), 200);
        log("Tempo: " + minutes + "m " + seconds + "s â†’ giro migliore");
    } else if (elapsed === worst) {
        setTimeout(() => playSound("worst lap.mp3"), 200);
        log("Tempo: " + minutes + "m " + seconds + "s â†’ giro peggiore");
    } else {
        setTimeout(() => playSound("normal lap time.mp3"), 200);
        log("Tempo: " + minutes + "m " + seconds + "s â†’ giro normale");
    }
}

  currentLap++; // ðŸ”¥ fondamentale

  startTime = Date.now();
  timerInterval = setInterval(updateTimer, 200);
}

function markMoment() {
  const moment = Date.now() - startTime;
  checkmarks.push({time: moment, lastLapTriggered: -1});
  if (!muteMode) {
    playSound("remind next lap.mp3");
  }
  log("Checkmark segnato a " + (moment/1000).toFixed(2) + "s");
}

function log(msg) {
  document.getElementById("log").innerHTML += msg + "<br>";
}

function initSpeech() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Il tuo browser non supporta SpeechRecognition.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "it-IT";
  recognition.continuous = true;
  recognition.interimResults = false; // ðŸ”¥ piÃ¹ stabile

recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
    log("Comando: " + transcript);

    // ðŸ”¥ IGNORA SILENZIO, RUMORE, PAROLE MONCHE
    if (transcript.trim() === "" || transcript.length < 2) {
        return;
    }

    if (["tempo","start","via","parti"].some(w => transcript.includes(w))) {
        startTimer();
    }
    else if (["fine","stop","ferma","chiudi","end"].some(w => transcript.includes(w))) {
        stopTimer();
    }
    else if (["tieni","ricorda","segna","mark"].some(w => transcript.includes(w))) {
        markMoment();
    }
    else if ([
        "stai zitto",
        "silenzio",
        "non parlare",
        "zitto",
        "radio off",
        "mute radio",
        "silenzio radio"
    ].some(w => transcript.includes(w))) {
        muteMode = true;
        playSound("talkno.mp3");
        log("ModalitÃ  silenziosa attivata");
    }
    else {
        log("Comando ignorato");
    }
};


  // ðŸ”¥ evita loop ON/OFF del microfono
  recognition.onend = () => {
    if (!audioPlaying) {
      setTimeout(() => recognition.start(), 300);
    }
  };

  recognition.start();
}

document.getElementById("startMic").onclick = initSpeech;

// ðŸ”¥ BLOCCO CHECKMARK CORRETTO
setInterval(() => {
  if (!startTime) return;

  const elapsed = Date.now() - startTime;

  checkmarks.forEach(mark => {
    if (!muteMode && mark.lastLapTriggered < currentLap) {
      if (Math.abs(elapsed - mark.time) < 300) {
        playSound("lap reminder_.mp3");
        mark.lastLapTriggered = currentLap;
      }
    }
  });
}, 200);

</script>

</body>
</html>

