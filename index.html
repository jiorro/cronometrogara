<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Cronometro vocale</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 40px; }
    #time { font-size: 2em; margin: 20px; }
    #log { text-align: left; margin: 20px auto; width: 60%; }
  </style>
</head>
<body>
  <h1>Cronometro con comandi vocali</h1>
  <div id="time">00:00.0</div>
  <button id="startMic">Attiva microfono</button>
  <div id="log"></div>

<script>
let startTime = null;
let timerInterval = null;
let laps = [];
let specialMoment = null;

// Aggiorna cronometro (minuti:secondi)
function updateTimer() {
  const elapsed = Date.now() - startTime;
  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);
  document.getElementById("time").textContent =
    String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
}

// Avvia cronometro
function startTimer() {
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 200);
  speak("tempo avviato");
  log("Cronometro avviato");
}

// Ferma cronometro e valuta giro
function stopTimer() {
  clearInterval(timerInterval);
  const elapsed = Date.now() - startTime;
  laps.push(elapsed);

  const minutes = Math.floor(elapsed / 60000);
  const seconds = ((elapsed % 60000) / 1000).toFixed(2);

  // Valutazione giro
  let message = "";
  const best = Math.min(...laps);
  const worst = Math.max(...laps);
  const position = laps.length;

  if (elapsed === best) {
    message = "giro migliore";
  } else if (elapsed === worst) {
    message = "giro peggiore";
  } else {
    message = "giro posizione " + position;
  }

  speak("Tempo " + minutes + " minuti e " + seconds + " secondi, " + message);
  log("Tempo: " + minutes + "m " + seconds + "s → " + message);

  startTimer(); // riparte subito
}

// Segna momento speciale
function markMoment() {
  specialMoment = Date.now() - startTime;
  speak("punto preso");
  log("Momento speciale segnato a " + (specialMoment/1000).toFixed(2) + "s");
}

// Sintesi vocale
function speak(text) {
  if ('speechSynthesis' in window) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "it-IT";
    // puoi scegliere una voce italiana se disponibile
    const voices = speechSynthesis.getVoices();
    const italianVoice = voices.find(v => v.lang.startsWith("it"));
    if (italianVoice) utter.voice = italianVoice;
    speechSynthesis.speak(utter);
  } else {
    console.log("Sintesi vocale non supportata dal browser.");
  }
}

// Log
function log(msg) {
  document.getElementById("log").innerHTML += msg + "<br>";
}

// Riconoscimento vocale
function initSpeech() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Il tuo browser non supporta SpeechRecognition.");
    return;
  }
  const recognition = new SpeechRecognition();
  recognition.lang = "it-IT";
  recognition.continuous = true;

  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
    log("Comando: " + transcript);

    // Sinonimi
    if (["tempo","start","via","parti"].some(w => transcript.includes(w))) {
      startTimer();
    }
    else if (["fine","stop","ferma","chiudi"].some(w => transcript.includes(w))) {
      stopTimer();
    }
    else if (["tieni","ricorda","segna","mark"].some(w => transcript.includes(w))) {
      markMoment();
    }
  };

  recognition.start();

  // Controllo continuo per "tieni"
  setInterval(() => {
    if (specialMoment !== null) {
      const elapsed = Date.now() - startTime;
      if (elapsed >= specialMoment) {
        // Suono personalizzato → sostituisci "suono.mp3" con il tuo file
        new Audio("suono.mp3").play();
        specialMoment = null;
      }
    }
  }, 200);
}

document.getElementById("startMic").onclick = initSpeech;
</script>
</body>
</html>
