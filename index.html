<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>box</title>

  <style>
    body { font-family: Arial; text-align: center; margin-top: 40px; }
    #time { font-size: 2em; margin: 20px; }
    #log { text-align: left; margin: 20px auto; width: 60%; }

    /* TIMER TOTALE IN ALTO A SINISTRA */
    #totalTime {
      position: absolute;
      top: 10px;
      left: 20px;
      font-size: 1.2em;
      font-weight: bold;
    }

    #lapCounter {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 1.2em;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <h1>ingeniere live</h1>

  <div id="totalTime">Totale: 00:00.000</div>
  <div id="time">00:00.000</div>
  <button id="startMic">Attiva radio</button>

  <div id="log"></div>
  <div id="lapCounter">Giro: 0</div>

<script>
/* -------------------------
   VARIABILI PRINCIPALI
------------------------- */
let startTime = null;
let totalStartTime = null;   // ðŸ”¥ parte dal primo via
let timerInterval = null;
let totalTimerInterval = null;

let laps = [];
let checkmarks = [];
let muteMode = false;
let currentLap = 0;
let audioPlaying = false;
let micStarted = false;

/* -------------------------
   AUDIO SICURO
------------------------- */
function playSound(file) {
  const s = new Audio(file);
  audioPlaying = true;

  s.onended = () => audioPlaying = false;
  s.onerror = () => audioPlaying = false;

  s.play();
}

/* -------------------------
   TIMER NORMALE
------------------------- */
function updateTimer() {
  if (startTime === null) return;
  const elapsed = Date.now() - startTime;
  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);

  document.getElementById("time").textContent =
    String(minutes).padStart(2, "0") + ":" +
    String(seconds).padStart(2, "0");
}

/* -------------------------
   TIMER TOTALE
------------------------- */
function updateTotalTimer() {
  if (totalStartTime === null) return;
  const elapsed = Date.now() - totalStartTime;

  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);
  const millis = Math.floor(elapsed % 1000);

  document.getElementById("totalTime").textContent =
    "Totale: " +
    String(minutes).padStart(2, "0") + ":" +
    String(seconds).padStart(2, "0") + "." +
    String(millis).padStart(3, "0");
}

/* -------------------------
   AVVIO TIMER
------------------------- */
function startTimer() {
  if (totalStartTime === null) {
    totalStartTime = Date.now();
    totalTimerInterval = setInterval(updateTotalTimer, 100);
  }

  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 200);

  playSound("starttime (1).mp3");
  log("Cronometro avviato");
}

/* -------------------------
   STOP TIMER (E RIPARTE)
------------------------- */
function stopTimer() {
  clearInterval(timerInterval);
  if (startTime === null) return;

  const elapsed = Date.now() - startTime;

  const hadLapsBefore = laps.length > 0;
  const bestBefore = hadLapsBefore ? Math.min(...laps) : Infinity;
  const worstBefore = hadLapsBefore ? Math.max(...laps) : -Infinity;

  laps.push(elapsed);

  const minutes = Math.floor(elapsed / 60000);
  const seconds = ((elapsed % 60000) / 1000).toFixed(2);

  currentLap++;
  updateLapCounter();

  if (muteMode) {
    setTimeout(() => playSound("talkno.mp3"), 200);
    log(`Tempo: ${minutes}m ${seconds}s â†’ silenzioso`);
  } else {
    if (!hadLapsBefore || elapsed <= bestBefore) {
      setTimeout(() => playSound("Record (online-voice-recorder (1).mp3"), 200);
      log(`Tempo: ${minutes}m ${seconds}s â†’ giro migliore`);
    } else if (elapsed >= worstBefore) {
      setTimeout(() => playSound("worst lap.mp3"), 200);
      log(`Tempo: ${minutes}m ${seconds}s â†’ giro peggiore`);
    } else {
      setTimeout(() => playSound("normal lap time.mp3"), 200);
      log(`Tempo: ${minutes}m ${seconds}s â†’ giro normale`);
    }
  }

  // ðŸ”¥ RIPARTE SUBITO
  startTime = Date.now();
  timerInterval = setInterval(updateTimer, 200);
}

/* -------------------------
   CHECKMARK
------------------------- */
function markMoment() {
  if (startTime === null) return;
  const moment = Date.now() - startTime;
  checkmarks.push({ time: moment, lastLapTriggered: -1 });

  if (!muteMode) playSound("remind next lap.mp3");

  log("Checkmark a " + (moment / 1000).toFixed(2) + "s");
}

/* -------------------------
   LOG
------------------------- */
function log(msg) {
  document.getElementById("log").innerHTML += msg + "<br>";
}

/* -------------------------
   VOCE ROBOTICA
------------------------- */
function speak(text) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "it-IT";
  speechSynthesis.speak(utter);
}

/* -------------------------
   MICROFONO
------------------------- */
function initSpeech() {
  if (micStarted) return;
  micStarted = true;

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Il tuo browser non supporta SpeechRecognition.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "it-IT";
  recognition.continuous = true;
  recognition.interimResults = false;
recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
    log("Comando: " + transcript);

    if (transcript.length < 2) return;

    if (["tempo","start","via","parti"].some(w => transcript.includes(w))) {
        startTimer();
    }
    else if (["fine","stop","ferma","chiudi","end"].some(w => transcript.includes(w))) {
        stopTimer();
    }
    else if (["tieni","ricorda","segna","mark"].some(w => transcript.includes(w))) {
        markMoment();
    }
    else if (["silenzio","stai zitto","non parlare","mute radio"].some(w => transcript.includes(w))) {
        muteMode = true;
        playSound("talkno.mp3");
        log("ModalitÃ  silenziosa attivata");
    }
    else if (["tempo totale","totale","tempo gara","tempo completo"].some(w => transcript.includes(w))) {
        const elapsed = Date.now() - totalStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);

        const text = `Sono passati ${minutes} minuti e ${seconds} secondi.`;
        speak(text);
        log("Tempo totale richiesto â†’ " + text);
    }
    else if (["giro","giri","quanti giri","numero giri","giri totali","totale giri"]
             .some(w => transcript.includes(w))) {

        const text = `Hai completato ${currentLap} giri.`;
        speak(text);
        log("Richiesta giri â†’ " + text);
    }
    else {
        log("Comando ignorato");
    }
};

  recognition.onend = () => {
    if (!audioPlaying) {
      setTimeout(() => recognition.start(), 300);
    }
  };

  recognition.start();
}

document.getElementById("startMic").onclick = initSpeech;

/* -------------------------
   COUNTER GIRI
------------------------- */
function updateLapCounter() {
  document.getElementById("lapCounter").textContent = "Giro: " + currentLap;
}

/* -------------------------
   CHECKMARK REMINDER
------------------------- */
setInterval(() => {
  if (startTime === null) return;

  const elapsed = Date.now() - startTime;

  checkmarks.forEach(mark => {
    if (!muteMode && mark.lastLapTriggered < currentLap) {
      if (Math.abs(elapsed - mark.time) < 300) {
        playSound("lap reminder_.mp3");
        mark.lastLapTriggered = currentLap;
      }
    }
  });
}, 200);

</script>

</body>
</html>
