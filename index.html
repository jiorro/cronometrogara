<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Cronometro vocale</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 40px; }
    #time { font-size: 2em; margin: 20px; }
    #log { text-align: left; margin: 20px auto; width: 60%; }
  </style>
</head>
<body>
  <h1>Cronometro con comandi vocali</h1>
  <div id="time">00:00.0</div>
  <button id="startMic">Attiva microfono</button>
  <p>comandi utilizzabili: per far cominciare il cronometro: tempo start via parti</p>
  <p>comandi utilizzabili: per far terminare il cronometro: fine stop ferma chiudi</p>
  <p>comandi utilizzabili: per segnare un momento sul cronometro: tieni ricorda segna mark</p>
  <p>comandi utilizzabili: per gestire i checkmark: spegni checkmark, annulla checkmark, no checkmark, non tieni, annulla tieni, riprendi checkmark</p>
  <div id="log"></div>

<script>
let startTime = null;
let timerInterval = null;
let laps = [];
let checkmarks = []; // lista di momenti segnati
let checkmarkActive = true; // flag per attivare/disattivare reminder

// Aggiorna cronometro (minuti:secondi)
function updateTimer() {
  const elapsed = Date.now() - startTime;
  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);
  document.getElementById("time").textContent =
    String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
}

// Avvia cronometro
function startTimer() {
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 200);
  speak("tempo avviato");
  log("Cronometro avviato");
}

// Ferma cronometro e valuta giro
function stopTimer() {
  clearInterval(timerInterval);
  const elapsed = Date.now() - startTime;
  laps.push(elapsed);

  const minutes = Math.floor(elapsed / 60000);
  const seconds = ((elapsed % 60000) / 1000).toFixed(2);

  let message = "";
  const best = Math.min(...laps);
  const worst = Math.max(...laps);
  const position = laps.length;

  if (elapsed === best) {
    message = "giro migliore";
  } else if (elapsed === worst) {
    message = "giro peggiore";
  } else {
    message = "giro posizione " + position;
  }

  speak("Tempo " + minutes + " minuti e " + seconds + " secondi, " + message);
  log("Tempo: " + minutes + "m " + seconds + "s â†’ " + message);

  startTimer(); // riparte subito
}

// Segna momento speciale (checkmark)
function markMoment() {
  const moment = Date.now() - startTime;
  checkmarks.push(moment);
  speak("punto preso");
  log("Checkmark segnato a " + (moment/1000).toFixed(2) + "s");
}

// Sintesi vocale
function speak(text) {
  if ('speechSynthesis' in window) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "it-IT";
    speechSynthesis.speak(utter);
  }
}

// Log
function log(msg) {
  document.getElementById("log").innerHTML += msg + "<br>";
}

// Riconoscimento vocale
function initSpeech() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Il tuo browser non supporta SpeechRecognition.");
    return;
  }
  const recognition = new SpeechRecognition();
  recognition.lang = "it-IT";
  recognition.continuous = true;

  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
    log("Comando: " + transcript);

    if (["tempo","start","via","parti"].some(w => transcript.includes(w))) {
      startTimer();
    }
    else if (["fine","stop","ferma","chiudi"].some(w => transcript.includes(w))) {
      stopTimer();
    }
    else if (["tieni","ricorda","segna","mark"].some(w => transcript.includes(w))) {
      markMoment();
    }
    else if (["spegni checkmark","annulla checkmark","no checkmark","non tieni","annulla tieni"].some(w => transcript.includes(w))) {
      checkmarkActive = false;
      speak("checkmark disattivato");
      log("Reminder checkmark in pausa");
    }
    else if (["riprendi checkmark","attiva checkmark","riattiva checkmark"].some(w => transcript.includes(w))) {
      checkmarkActive = true;
      speak("checkmark riattivato");
      log("Reminder checkmark riattivato");
    }
  };

  recognition.start();

  // Controllo continuo dei checkmark
  setInterval(() => {
    if (checkmarkActive && checkmarks.length > 0) {
      const elapsed = Date.now() - startTime;
      checkmarks.forEach(moment => {
        if (Math.abs(elapsed - moment) < 300) { // tolleranza 0.3s
          new Audio("suono.mp3").play(); // sostituisci con il tuo file
        }
      });
    }
  }, 200);
}

document.getElementById("startMic").onclick = initSpeech;
</script>
</body>
</html>
