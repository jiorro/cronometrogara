<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>box</title>

  <style>
    body { font-family: Arial; text-align: center; margin-top: 40px; }
    #time { font-size: 2em; margin: 20px; }
    #log { text-align: left; margin: 20px auto; width: 60%; }
    #lapCounter {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 1.2em;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <h1>ingeniere live</h1>

  <div id="time">00:00.000</div>
  <button id="startMic">Attiva radio</button>

  <p>comandi per avviare: tempo, start, via, parti</p>
  <p>comandi per fermare: fine, stop, ferma, chiudi</p>
  <p>comandi per segnare: tieni, ricorda, segna, mark</p>

  <div id="log"></div>
  <div id="lapCounter">Giro: 0</div>

<script>
/* -------------------------
   VARIABILI PRINCIPALI
------------------------- */
let startTime = null;
let timerInterval = null;
let laps = [];
let checkmarks = [];
let muteMode = false;
let currentLap = 0;
let audioPlaying = false;
let micStarted = false;

/* -------------------------
   AUDIO SICURO
------------------------- */
function playSound(file) {
  const s = new Audio(file);
  audioPlaying = true;

  s.onended = () => audioPlaying = false;
  s.onerror = () => audioPlaying = false;

  s.play();
}

/* -------------------------
   TIMER
------------------------- */
function updateTimer() {
  const elapsed = Date.now() - startTime;
  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);

  document.getElementById("time").textContent =
    String(minutes).padStart(2, "0") + ":" +
    String(seconds).padStart(2, "0");
}

function startTimer() {
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 200);

  playSound("starttime (1).mp3");
  log("Cronometro avviato");
}

function stopTimer() {
  clearInterval(timerInterval);

  const elapsed = Date.now() - startTime;
  laps.push(elapsed);

  const minutes = Math.floor(elapsed / 60000);
  const seconds = ((elapsed % 60000) / 1000).toFixed(2);

  const best = Math.min(...laps);
  const worst = Math.max(...laps);

  currentLap++;
  updateLapCounter();

  if (muteMode) {
    setTimeout(() => playSound("talkno.mp3"), 200);
    log(`Tempo: ${minutes}m ${seconds}s → silenzioso`);
  } else {
    if (elapsed <= best) {
      setTimeout(() => playSound("Record (online-voice-recorder (1)).mp3"), 200);
      log(`Tempo: ${minutes}m ${seconds}s → giro migliore`);
    } else if (elapsed === worst) {
      setTimeout(() => playSound("worst lap.mp3"), 200);
      log(`Tempo: ${minutes}m ${seconds}s → giro peggiore`);
    } else {
      setTimeout(() => playSound("normal lap time.mp3"), 200);
      log(`Tempo: ${minutes}m ${seconds}s → giro normale`);
    }
  }

  // Il cronometro NON riparte automaticamente
}

/* -------------------------
   CHECKMARK
------------------------- */
function markMoment() {
  const moment = Date.now() - startTime;
  checkmarks.push({ time: moment, lastLapTriggered: -1 });

  if (!muteMode) playSound("remind next lap.mp3");

  log("Checkmark a " + (moment / 1000).toFixed(2) + "s");
}

/* -------------------------
   LOG
------------------------- */
function log(msg) {
  document.getElementById("log").innerHTML += msg + "<br>";
}

/* -------------------------
   MICROFONO
------------------------- */
function initSpeech() {
  if (micStarted) return;  // evita più microfoni
  micStarted = true;

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Il tuo browser non supporta SpeechRecognition.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "it-IT";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
    log("Comando: " + transcript);

    if (transcript.length < 2) return;

    if (["tempo","start","via","parti"].some(w => transcript.includes(w))) {
      startTimer();
    }
    else if (["fine","stop","ferma","chiudi","end"].some(w => transcript.includes(w))) {
      stopTimer();
    }
    else if (["tieni","ricorda","segna","mark"].some(w => transcript.includes(w))) {
      markMoment();
    }
    else if (["silenzio","stai zitto","non parlare","mute radio"].some(w => transcript.includes(w))) {
      muteMode = true;
      playSound("talkno.mp3");
      log("Modalità silenziosa attivata");
    }
    else {
      log("Comando ignorato");
    }
  };

  recognition.onend = () => {
    if (!audioPlaying) {
      setTimeout(() => recognition.start(), 300);
    }
  };

  recognition.start();
}

document.getElementById("startMic").onclick = initSpeech;

/* -------------------------
   COUNTER GIRI
------------------------- */
function updateLapCounter() {
  document.getElementById("lapCounter").textContent = "Giro: " + currentLap;
}

/* -------------------------
   CHECKMARK REMINDER
------------------------- */
setInterval(() => {
  if (!startTime) return;

  const elapsed = Date.now() - startTime;

  checkmarks.forEach(mark => {
    if (!muteMode && mark.lastLapTriggered < currentLap) {
      if (Math.abs(elapsed - mark.time) < 300) {
        playSound("lap reminder_.mp3");
        mark.lastLapTriggered = currentLap;
      }
    }
  });
}, 200);

</script>

</body>
</html>

