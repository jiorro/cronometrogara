<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>box live</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 40px; }
    #time { font-size: 2em; margin: 20px; }
    #log { text-align: left; margin: 20px auto; width: 60%; }
  </style>
</head>
<body>
  <h1>ingeniere di pista </h1>
  <div id="time">00:00.000</div>
  <button id="startMic">Attiva radio</button>
  <p>comandi utilizzabili per far cominciare il cronometro: tempo start via parti</p>
  <p>comandi utilizzabili per far terminare il cronometro: fine stop ferma chiudi</p>
  <p>comandi utilizzabili per segnare un momento sul cronometro: tieni ricorda segna mark</p>
  <p>comandi utilizzabili per gestire i checkmark: spegni checkmark, annulla checkmark, no checkmark, non tieni, annulla tieni, riprendi checkmark</p>
  <div id="log"></div>

<script>
let startTime = null;
let timerInterval = null;
let laps = [];
let checkmarks = [];
let checkmarkActive = true;
let muteMode = false; // nuovo flag per modalità silenziosa

function updateTimer() {
  const elapsed = Date.now() - startTime;
  const minutes = Math.floor(elapsed / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);
  document.getElementById("time").textContent =
    String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
}

function startTimer() {
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 200);
  new Audio("starttime (1).mp3").play();
  log("Cronometro avviato");
}

function stopTimer() {
  clearInterval(timerInterval);
  const elapsed = Date.now() - startTime;
  laps.push(elapsed);

  const minutes = Math.floor(elapsed / 60000);
  const seconds = ((elapsed % 60000) / 1000).toFixed(2);

  const best = Math.min(...laps);
  const worst = Math.max(...laps);

  if (muteMode) {
    new Audio("talkno.mp3").play(); // modalità silenziosa
    log("Tempo: " + minutes + "m " + seconds + "s → silenzioso");
  } else {
    if (elapsed === best) {
      new Audio("Record (online-voice-recorder (1).mp3").play();
      log("Tempo: " + minutes + "m " + seconds + "s → giro migliore");
    } else if (elapsed === worst) {
      new Audio("worst lap.mp3").play();
      log("Tempo: " + minutes + "m " + seconds + "s → giro peggiore");
    } else {
      new Audio("normal lap time.mp3").play();
      log("Tempo: " + minutes + "m " + seconds + "s → giro normale");
    }
  }

  startTime = Date.now();
  timerInterval = setInterval(updateTimer, 200);
}

function markMoment() {
  const moment = Date.now() - startTime;
  checkmarks.push({time: moment, lastLapTriggered: -1});
  if (!muteMode) {
    new Audio("remind next lap.mp3").play();
  }
  log("Checkmark segnato a " + (moment/1000).toFixed(2) + "s");
}

function log(msg) {
  document.getElementById("log").innerHTML += msg + "<br>";
}

function initSpeech() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Il tuo browser non supporta SpeechRecognition.");
    return;
  }
  const recognition = new SpeechRecognition();
  recognition.lang = "it-IT";
  recognition.continuous = true;

  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
    log("Comando: " + transcript);

    if (["tempo","start","via","parti"].some(w => transcript.includes(w))) {
      startTimer();
    }
    else if (["fine","stop","ferma","chiudi"].some(w => transcript.includes(w))) {
      stopTimer();
    }
    else if (["tieni","ricorda","segna","mark"].some(w => transcript.includes(w))) {
      markMoment();
    }
    else if (["spegni checkmark","annulla checkmark","no checkmark","non tieni","annulla tieni"].some(w => transcript.includes(w))) {
      checkmarkActive = false;
      log("Reminder checkmark in pausa");
    }
    else if (["riprendi checkmark","attiva checkmark","riattiva checkmark"].some(w => transcript.includes(w))) {
      checkmarkActive = true;
      log("Reminder checkmark riattivato");
    }
    else if (["stai zitto","silenzio","non parlare", "zitto", "shhh", "if you talk whit me again i will disconnect the radio"].some(w => transcript.includes(w))) {
      muteMode = true;
      new Audio("talkno.mp3").play();
      log("Modalità silenziosa attivata");
    }
    else if (["parla ancora","riprendi voce","torna a parlare", "parla" "non stare zitto"].some(w => transcript.includes(w))) {
      muteMode = false;
      new Audio("talk.mp3").play();
      log("Modalità parlante riattivata");
    }
    else {
      // comando non riconosciuto
      new Audio("starttime (2).mp3").play();
      log("Comando non riconosciuto");
    }
  };

  recognition.onend = () => {
    recognition.start();
  };

  recognition.start();

  setInterval(() => {
    checkmarks.forEach(mark => {
      if (mark.lastLapTriggered < currentLap) {
        if (Math.abs(elapsed - mark.time) < 300) {
          new Audio("lap reminder_.mp3").play();
          mark.lastLapTriggered = currentLap;
        }
      }
    });
  }
}, 200);
} // <-- chiusura di initSpeech()

</script>

<!-- collegamento del bottone -->
<script>
document.getElementById("startMic").onclick = initSpeech;
</script>

</body>
</html>
