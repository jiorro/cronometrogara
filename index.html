<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>box in tasca</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 40px; }
    #time { font-size: 2em; margin: 20px; }
    #log { text-align: left; margin: 20px auto; width: 60%; }
  </style>
</head>
<body>
  <h1>Cronometro con comandi vocali</h1>
  <div id="time">00:00.0</div>
  <button id="startMic">Attiva microfono</button>
  <p>comandi utilizzabili: per far cominciare il cronometro: tempo start via parti</p>
  <p>comandi utilizzabili: per far terminare il cronometro: fine stop ferma chiudi</p>
  <p>comandi utilizzabili: per segnare un momento sul cronometro: tieni ricorda segna mark</p>
  <p>comandi utilizzabili: per gestire i checkmark: spegni checkmark, annulla checkmark, no checkmark, non tieni, annulla tieni, riprendi checkmark</p>
  <div id="log"></div>

<script>
let startTime = null;
let timerInterval = null;
let laps = [];
let checkmarks = [];
let checkmarkActive = true;

// Avvia cronometro
function startTimer() {
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 200);
  new Audio("starttime (1).mp3").play(); // feedback avvio
  log("Cronometro avviato");
}

// Ferma cronometro e valuta giro
function stopTimer() {
  clearInterval(timerInterval);
  const elapsed = Date.now() - startTime;
  laps.push(elapsed);

  const minutes = Math.floor(elapsed / 60000);
  const seconds = ((elapsed % 60000) / 1000).toFixed(2);

  const best = Math.min(...laps);
  const worst = Math.max(...laps);

  if (elapsed === best) {
    new Audio("Record (online-voice-recorder (1).mp3").play();
    log("Tempo: " + minutes + "m " + seconds + "s → giro migliore");
  } else if (elapsed === worst) {
    new Audio("worst lap.mp3").play();
    log("Tempo: " + minutes + "m " + seconds + "s → giro peggiore");
  } else {
    new Audio("normal lap time.mp3").play();
    log("Tempo: " + minutes + "m " + seconds + "s → giro normale");
  }

  startTimer(); // riparte subito
}

// Segna momento speciale (checkmark)
function markMoment() {
  const moment = Date.now() - startTime;
  checkmarks.push({time: moment, activeNextLap: true, lastLapTriggered: -1});
  new Audio("remind next lap.mp3").play(); // conferma segnalazione
  log("Checkmark segnato a " + (moment/1000).toFixed(2) + "s");
}

// Controllo continuo dei checkmark
setInterval(() => {
  if (checkmarkActive && checkmarks.length > 0 && startTime) {
    const elapsed = Date.now() - startTime;

    checkmarks.forEach(mark => {
      // calcolo giro corrente (numero di giri già completati)
      const currentLap = laps.length;

      // se siamo al giro successivo rispetto a quando è stato segnato
      if (mark.activeNextLap && mark.lastLapTriggered < currentLap) {
        if (Math.abs(elapsed - mark.time) < 300) { // tolleranza 0.3s
          new Audio("lap reminder_.mp3").play();
          mark.lastLapTriggered = currentLap; // segna che ha già suonato in questo giro
        }
      }
    });
  }
}, 200);

</script>
</body>
</html>
